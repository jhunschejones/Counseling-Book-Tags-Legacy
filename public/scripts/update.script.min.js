function truncate(str,len){var subString=str.substr(0,len-1);return subString.substr(0,subString.lastIndexOf(" ")).replace(/(^[,\s]+)|([,\s]+$)/g,"")+"..."}function toggleContentAndArrows(content,up,down){let query=$(`#${content}`),downArrow=$(`#${down}`),upArrow=$(`#${up}`);var isVisible;!0===query.is(":visible")?(query.hide(),downArrow.show(),upArrow.hide()):(query.show(),downArrow.hide(),upArrow.show())}function safeInput(userInput){return!(userInput.includes("<")||userInput.includes(">")||userInput.includes("function(")||userInput.includes("function ("))}function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}var bookData,userID,existingTags=[];const bookID=new URL(document.location).searchParams.get("id"),action=new URL(document.location).searchParams.get("clicked")||!1;function getBookDetails(handleData){$("#results-for-this-letter").html(""),$.ajax({method:"GET",url:"/api/v1/book/"+bookID,success:function(data){handleData(data)},error:function(){$(".container-fluid").html(""),$(".container-fluid").append('<br/><br/><br/><p style="text-align:center;">Oops, looks like we couldn\'t find a book with that ID! Head back <a href="/">home</a> to try again.</p>')}})}function poulatePage(){if($("#book-title").text(bookData.title),$("#book-author").html("&nbsp&nbsp-&nbsp;"+bookData.author),$("#book-cover").attr("src",bookData.cover),$("#publisher").text(bookData.publisher),$("#published-year").html("&nbsp;&copy;"+bookData.published),$("#book-description").html(bookData.description),bookData.tagObjects.length>0){existingTags=[],$("#book-tags").html("");for(let index=0;index<bookData.tagObjects.length;index++){const tagObject=bookData.tagObjects[index];let displayTag;displayTag=tagObject.tag.length>40?truncate(tagObject.tag,40):tagObject.tag,$("#book-tags").append(`<a class="tag badge badge-pill" data-tag="${tagObject.tag}" data-creator="${tagObject.creator}"><span class="tag-clicker" data-tag="${tagObject.tag}" data-creator="${tagObject.creator}">${displayTag}</span><span class="delete-button" data-tag="${tagObject.tag}" data-creator="${tagObject.creator}">&#10005;</span></a>`),existingTags.push(tagObject.tag.toUpperCase())}}else $("#book-tags").html('<span class="text-secondary">There are no tags yet for this book.</span>');if(bookData.comments.length>0){$("#book-comments").html("");for(let index=0;index<bookData.comments.length;index++){const comment=bookData.comments[index];let horizontalRule;horizontalRule=0===index?"":"<hr />",$("#book-comments").append(`${horizontalRule}<p class="comment" data-creator="${comment.creator}">"${comment.text}"<span class="text-secondary"> - ${comment.displayName||"Unknown"}</span><span class="delete-button" data-comment-index="${index}" data-creator="${comment.creator}">&#10005;</span></p>`)}}else $("#book-comments").html('<span class="text-secondary">There are no comments yet for this book.</span>');$("#tags-spinner").hide(),$(".delete-button").on("click",function(){if($(this).attr("data-tag")){let deleteTag,deleteCreator,deleteObject={tag:$(this).attr("data-tag"),creator:$(this).attr("data-creator")};$.ajax({method:"DELETE",url:"/api/v1/book/tags/"+bookID,data:JSON.stringify(deleteObject),contentType:"application/json",success:function(data){getBookDetails(function(output){bookData=output,poulatePage()})}})}if($(this).attr("data-comment-index")){let clickedComment=bookData.comments[$(this).attr("data-comment-index")],deleteObject={displayName:clickedComment.displayName,text:clickedComment.text,creator:clickedComment.creator};$.ajax({method:"DELETE",url:"/api/v1/book/comments/"+bookID,data:JSON.stringify(deleteObject),contentType:"application/json",success:function(data){getBookDetails(function(output){bookData=output,poulatePage()})}})}}),$(".tag-clicker").on("click",function(){window.location.href="/results?tags="+$(this).attr("data-tag").replace(/,/g,"%2C")}),showDeleteButtons()}function addTag(){let bookID=bookData._id,newTag=capitalizeFirstLetter($("#add-tag-input").val().trim());if(""!=newTag)if(-1===existingTags.indexOf(newTag.toUpperCase()))if(safeInput(newTag)){let updateObject={tag:newTag,creator:userID};$.ajax({method:"PUT",url:"/api/v1/book/tags/"+bookID,data:JSON.stringify(updateObject),contentType:"application/json",success:function(data){getBookDetails(function(output){bookData=output,poulatePage()}),$("#add-tag-input").val(""),$("#add-tag-modal").modal("toggle")}})}else alert("Some characters are now allowed in tag text."),$("#add-tag-input").val("");else alert(`The "${newTag}" tag already exists!`),$("#add-tag-input").val("");else alert("Please add some text for your tag!")}function addComment(){let bookID=bookData._id,newCommentText=$("#add-comment-text-area").val().trim().replace(/(\r\n|\n|\r)/g,"<br /><br />").replace(/<br \/><br \/><br \/><br \/>/g,"<br /><br />"),displayName=capitalizeFirstLetter($("#display-name").val().trim());if(!safeInput(displayName))return alert("Some characters are now allowed in display name."),$("#display-name").val(""),void $("#display-name").focus();if(""!=newCommentText){let updateObject={text:newCommentText,displayName:displayName,creator:userID};$.ajax({method:"PUT",url:"/api/v1/book/comments/"+bookID,data:JSON.stringify(updateObject),contentType:"application/json",success:function(data){getBookDetails(function(output){bookData=output,poulatePage()}),$("#add-comment-text-area").val(""),$("#display-name").val(""),$("#add-comment-modal").modal("toggle")}})}else alert("Please add some text for your comment!")}function showDeleteButtons(){for(let index=0;index<$(".delete-button").length;index++){const element=$(".delete-button")[index];element.dataset.creator==userID?($(element).show(),$(element).parent().is("a")&&$(element).parent().removeClass("tag").addClass("selected-tag badge-light"),$(element).parent().is("p")&&$(element).parent().removeClass("comment").addClass("comment-editable")):($(element).hide(),$(element).parent().is("a")&&$(element).parent().removeClass("selected-tag badge-light").addClass("tag"),$(element).parent().is("p")&&$(element).parent().removeClass("comment-editable").addClass("comment"))}}function logIn(){firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(function(){let provider=new firebase.auth.GoogleAuthProvider;return firebase.auth().signInWithPopup(provider)}).then(function(result){var token=result.credential.accessToken,user=result.user;userID=user.uid}).catch(function(error){var errorCode=error.code,errorMessage=error.message,email=error.email,credential=error.credential})}function logOut(){firebase.auth().signOut().then(function(){userID=null,$("#logged-in-content").hide(),$("#logged-out-message").show(),$(".delete-button").hide()}).catch(function(error){})}getBookDetails(function(output){output?(bookData=output,poulatePage()):($(".container-fluid").html(""),$(".container-fluid").append('<br/><br/><br/><p style="text-align:center;">Oops, looks like we couldn\'t find a book with that ID! Head back <a href="/">home</a> to try again.</p>'))}),document.getElementById("add-tag-submit").addEventListener("click",function(){addTag()}),document.getElementById("add-comment-submit").addEventListener("click",function(){addComment()}),document.getElementById("log-in-button").addEventListener("click",logIn),document.getElementById("up-arrow").addEventListener("click",function(){toggleContentAndArrows("book-description","up-arrow","down-arrow")}),document.getElementById("down-arrow").addEventListener("click",function(){toggleContentAndArrows("book-description","up-arrow","down-arrow")}),$("#add-comment-modal").on("shown.bs.modal",function(){setTimeout(function(){$("#display-name").focus()},100)}),$("#add-tag-modal").on("shown.bs.modal",function(){setTimeout(function(){$("#add-tag-input").focus()},100)}),firebase.auth().onAuthStateChanged(function(user){user?(userID=firebase.auth().currentUser.uid,$("#logged-out-message").hide(),$("#logged-in-content").show(),showDeleteButtons(),"add-tag"===action&&($("#add-tag-modal").modal("toggle"),window.history.pushState({},"",window.location.href.replace("&clicked=add-tag",""))),"add-comment"===action&&($("#add-comment-modal").modal("toggle"),window.history.pushState({},"",window.location.href.replace("&clicked=add-comment","")))):(console.log("User is not logged in!"),$("#logged-in-content").hide(),$("#logged-out-message").show(),$(".delete-button").hide())});