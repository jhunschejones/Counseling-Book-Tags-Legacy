function truncate(str,len){var subString=str.substr(0,len-1);return subString.substr(0,subString.lastIndexOf(" ")).replace(/(^[,\s]+)|([,\s]+$)/g,"")+"..."}function toggleContentAndArrows(content,up,down){let query=$(`#${content}`),downArrow=$(`#${down}`),upArrow=$(`#${up}`);var isVisible;!0===query.is(":visible")?(query.hide(),downArrow.show(),upArrow.hide()):(query.show(),downArrow.hide(),upArrow.show())}var bookData;const bookID=new URL(document.location).searchParams.get("id");var bookLocation;function getBookDetails(handleData){"database"===bookLocation?$.ajax({method:"GET",url:"/api/v1/book/"+bookID,success:function(data){handleData(data)},error:function(){$(".container-fluid").html(""),$(".container-fluid").append('<br/><br/><br/><p style="text-align:center;">Oops, looks like we couldn\'t find a book with that ID! Head back <a href="/">home</a> to try again.</p>')}}):$.ajax({method:"GET",url:`/api/v1/search/details/${bookID}`,success:function(data){handleData(data)},error:function(){$(".container-fluid").html(""),$(".container-fluid").append('<br/><br/><br/><p style="text-align:center;">Oops, looks like we couldn\'t find a book with that ID! Head back <a href="/">home</a> to try again.</p>')}})}function addNewBook(goodreadsBookID,buttonClicked){let newBookData;$.ajax({method:"GET",url:`/api/v1/search/details/${goodreadsBookID}`,success:function(data){newBookData=data}}).then(function(){let newBook={goodreadsBookID:newBookData.goodreadsBookID,title:newBookData.title,author:newBookData.author,isbn:newBookData.isbn,isbn13:newBookData.isbn13,published:newBookData.published,publisher:newBookData.publisher,cover:newBookData.cover,description:newBookData.description,language:newBookData.language,sameBook:[],tagObjects:[],tags:[],comments:[]};$.ajax({method:"POST",url:"/api/v1/book/",data:JSON.stringify(newBook),contentType:"application/json",success:function(data){window.location.href=`/update?id=${data}&clicked=${buttonClicked}`},error:function(){alert("Oh no! This book is missing some information required in order for us to be able to add it to the database. Please select a different new book or search by different criteria.")}})})}function poulatePage(){if($("#book-title").text(bookData.title),$("#book-author").html("&nbsp&nbsp-&nbsp;"+bookData.author),$("#book-cover").attr("src",bookData.cover),$("#publisher").text(bookData.publisher),$("#published-year").html("&nbsp;&copy;"+bookData.published),$("#book-description").html(bookData.description),bookData.tagObjects&&bookData.tagObjects.length>0)for(let index=0;index<bookData.tagObjects.length;index++){const tagObject=bookData.tagObjects[index];let displayTag;displayTag=tagObject.tag.length>40?truncate(tagObject.tag,40):tagObject.tag,$("#book-tags").append(`<button class="tag badge badge-pill" data-tag-creator="${tagObject.creator}" value="${tagObject.tag}">${displayTag}</button>`)}else $("#book-tags").html('<span class="text-secondary">There are no tags yet for this book.</span>');if(bookData.comments&&bookData.comments.length>0)for(let index=0;index<bookData.comments.length;index++){const comment=bookData.comments[index];let horizontalRule;horizontalRule=0===index?"":"<hr />",$("#book-comments").append(`${horizontalRule}<p class="comment">"${comment.text}"<span class="text-secondary"> - ${comment.displayName||"Unknown"}</span></p>`)}else $("#book-comments").html('<span class="text-secondary">There are no comments yet for this book.</span>');document.getElementById("up-arrow").addEventListener("click",function(){toggleContentAndArrows("book-description","up-arrow","down-arrow")}),document.getElementById("down-arrow").addEventListener("click",function(){toggleContentAndArrows("book-description","up-arrow","down-arrow")}),$(".tag").on("click",function(){window.location.href="/results?tags="+$(this).attr("value").replace(/,/g,"%2C")}),$("#add-comment-button").on("click",function(){let goodreadsBookID=bookData.goodreadsBookID,titleKeyWords=bookData.title,similarBookTitles;"database"===bookLocation?window.location.href=`/update?id=${bookData._id}&clicked=add-comment`:$.ajax({method:"GET",url:"/api/v1/book/title/"+titleKeyWords,success:function(data){similarBookTitles=data}}).then(function(){if(similarBookTitles.length>0){$("#add-new-book-modal-body").html(""),$("#add-new-book-modal").modal("toggle");let booksList='<ul id="alternate-book-list">';similarBookTitles.forEach(book=>{booksList+=`<li class="alternate-book text-primary" data-bookID="${book._id}">${book.title}</li>`}),booksList+="</ul>",1==similarBookTitles.length?$("#add-new-book-tile").text("Did you mean this book instead?"):$("#add-new-book-tile").text("Did you mean one of these books instead?"),$("#add-new-book-modal-body").append(booksList),$(".alternate-book").on("click",function(){window.location.href="/update?id="+$(this).attr("data-bookID")+"&clicked=add-comment"}),document.getElementById("add-new-book-button").addEventListener("click",function(){addNewBook(goodreadsBookID,"add-comment")})}else addNewBook(goodreadsBookID,"add-comment")})}),$("#add-tag-button").on("click",function(){let goodreadsBookID=bookData.goodreadsBookID,titleKeyWords=bookData.title,similarBookTitles;"database"===bookLocation?window.location.href=`/update?id=${bookData._id}&clicked=add-tag`:$.ajax({method:"GET",url:"/api/v1/book/title/"+titleKeyWords,success:function(data){similarBookTitles=data}}).then(function(){if(similarBookTitles.length>0){$("#add-new-book-modal-body").html(""),$("#add-new-book-modal").modal("toggle");let booksList='<ul id="alternate-book-list">';similarBookTitles.forEach(book=>{booksList+=`<li class="alternate-book text-primary" data-bookID="${book._id}">${book.title}</li>`}),booksList+="</ul>",1==similarBookTitles.length?$("#add-new-book-tile").text("Did you mean this book instead?"):$("#add-new-book-tile").text("Did you mean one of these books instead?"),$("#add-new-book-modal-body").append(booksList),$(".alternate-book").on("click",function(){window.location.href="/update?id="+$(this).attr("data-bookID")+"&clicked=add-tag"}),document.getElementById("add-new-book-button").addEventListener("click",function(){addNewBook(goodreadsBookID,"add-tag")})}else addNewBook(goodreadsBookID,"add-tag")})})}bookLocation=24===bookID.length?"database":"goodreadsAPI",getBookDetails(function(output){output?(bookData=output,poulatePage()):($(".container-fluid").html(""),$(".container-fluid").append('<br/><br/><br/><p style="text-align:center;">Oops, looks like we couldn\'t find a book with that ID! Head back <a href="/">home</a> to try again.</p>'))});