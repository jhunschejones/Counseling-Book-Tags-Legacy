<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <style>
      body {
        background-color: #eaeaea;
        color: #373f51;
      }
      #main-nav,
      #main-nav a {
        background-color: #c0d6df;
        color: #373f51;
      }
      #page-content-label,
      .warning-text {
        color: #373f51;
      }
      #book-title {
        color: #373f51;
        margin-top: 10px;
        margin-bottom: 0px;
      }
      #book-author {
        margin: 0px 0px 5px 0px;
      }
      #book-cover {
        box-shadow: 5px 5px 10px rgba(128, 128, 128, 0.678);
      }
      #book-publication {
        margin-top: 5px;
      }
      .tag {
        cursor: pointer;
        display: block;
        padding: 5px 10px;
        margin-right: 8px;
        margin-bottom: 6px;
        font-size: 0.8em;
        color: #373f51;
        background-color: #c0d6df;
        display: inline-flex;
        border-color: rgb(216, 216, 216) rgb(209, 209, 209) rgb(186, 186, 186);
        border-style: solid;
        border-width: 1px;
        /* box-shadow: 2px 2px 4px lightgrey; */
      }
      #up-arrow img,
      #down-arrow img {
        width: 22px;
        opacity: 0.3;
        cursor: pointer;
        padding: 2px 0px;
      }
      #up-arrow, 
      #down-arrow {
        margin-left: 10px;
      }
      #book-description,
      #up-arrow {
        display: none;
      }
      #comments-card,
      #tags-card {
        background-color: #eaeaea;
      }
      #comments-card .card-body,
      #tags-card .card-body {
        padding: 10px 15px;;
      }
      @media screen and (max-width: 750px) {
        .hide-small {
            display: none !important;
        }
      }
      @media screen and (min-width: 751px) {

      }
    </style>

    <title>Counseling Book Tags</title>
  </head>
  <body>
    <!-- NAVBAR -->
    <nav id="main-nav" class="navbar navbar-expand navbar-light">
      <div class="navbar-nav">
        <a class="nav-item nav-link active" href="/">Home</a>
        <a class="nav-item nav-link active" href="/search">Update</a>
        <a class="nav-item nav-link active" href="#">About</a>
        <a class="nav-item nav-link active" href="#">Contact</a>
      </div>
    </nav>
    <!-- NAVBAR -->

    <!-- PAGE CONTENT -->
    <div class="container-fluid">
      <div class="row no-gutters">
        <div class="col">
          <h4 id="book-title"></h4>
          <h4 id="book-author" class="text-secondary"></h4>
          <img id="book-cover" src="" alt="Book Cover Image">
          <p id="book-publication"><span id="publisher"></span><span id="published-year"></span></p>
          <h5>Description:<span id="up-arrow"><img src="./public/images/up_arrow.png" alt="Up Arrow"></span><span id="down-arrow"><img src="./public/images/down_arrow.png" alt="Down Arrow"></span></h5>
          <p id="book-description"></p>
        </div>

        <div class="col">
          <br/>
          <div id="tags-card" class="card">
            <div class="card-body">
              <h5 class="card-title">Tags:</h5>
              <p id="book-tags" class="card-text"></p>
            </div>
          </div>
          <br/>
          <div id="comments-card" class="card">
            <div class="card-body">
              <h5 class="card-title">Comments:</h5>
              <p id="book-comments" class="card-text"></p>
            </div>
          </div>
          <br/>
        </div>
      </div>
    </div>
    <!-- PAGE CONTENT -->

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" crossorigin="anonymous"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script> -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script>
      // ====== Start Utility Functions ======
      function truncate(str, len){
        // set up the substring
        var subString = str.substr(0, len-1);
        // add elipse after last complete word and trim trailing comma
        return (
          subString.substr(0, subString.lastIndexOf(' '))
          .replace(/(^[,\s]+)|([,\s]+$)/g, '') + '...'
        )
      }

      function toggleContentAndArrows(content, up, down) {
        let query = $(`#${content}`); 
        let downArrow = $(`#${down}`); 
        let upArrow = $(`#${up}`); 

        // check if element is Visible
        var isVisible = query.is(':visible');
    
        if (isVisible === true) {
          // element was Visible
          query.hide()
          downArrow.show()
          upArrow.hide()
        } else {
          // element was Hidden
          query.show()
          downArrow.hide()
          upArrow.show()
        }
      }
      // ====== End Utility Functions ======
      var bookData
      const bookID = window.location.search.replace(/\?/g, '')

      // setting a function as the input parameter to use laster 
      // when handling the returned data
      function getBookDetails(handleData) {
        $("#results-for-this-letter").html('')
        $.ajax({
          method: "GET",
          url: "/api/v1/book/" + bookID,
          success: function(data) {
            handleData(data)
          },
          error: function() {
            $('.container-fluid').html('')
            $('.container-fluid').append(`<br/><br/><br/><p style="text-align:center;">Oops, looks like we couldn't find a book with that ID! Head back <a href="/">home</a> to try again.</p>`)
          }
        })
      }  

      getBookDetails(function(output) {
        if (output) {
          bookData = output
          poulatePage()
        } else {
          // handle successful respons with no results
          $('.container-fluid').html('')
          $('.container-fluid').append(`<br/><br/><br/><p style="text-align:center;">Oops, looks like we couldn't find a book with that ID! Head back <a href="/">home</a> to try again.</p>`)
        }
      })

      function poulatePage() {
        $('#book-title').text(bookData.title)
        $('#book-author').html("&nbsp&nbsp-&nbsp;" + bookData.author)
        $('#book-cover').attr('src', bookData.cover)
        $('#publisher').text(bookData.publisher)
        $('#published-year').html("&nbsp;&copy;" + bookData.published)
        $('#book-description').html(bookData.description)

        if (bookData.tagObjects.length > 0) {
          for (let index = 0; index < bookData.tagObjects.length; index++) {
            const tagObject = bookData.tagObjects[index];

            let displayTag
            if (tagObject.tag.length > 40) { displayTag = truncate(tagObject.tag, 40) }
            else { displayTag = tagObject.tag }
            
            $('#book-tags').append(`<button class="tag badge badge-pill" data-tag-creator="${tagObject.creator}" value="${tagObject.tag}">${displayTag}</button>`)
          }
        } else {
          $('#book-tags').html('<span class="text-secondary">There are no tags yet for this book.</span>')
        }

        if (bookData.comments.length > 0) {
          bookData.comments.forEach(comment => {
            $('#book-comments').append(`<span class="comment" data-comment-creator="${comment.creator}">${comment.text}</span>`)
          })
        } else {
          $('#book-comments').html('<span class="text-secondary">There are no comments yet for this book.</span>')
        }

        // ====== Add event listeners ======
        document.getElementById("up-arrow").addEventListener("click", function(){
          toggleContentAndArrows('book-description', 'up-arrow', 'down-arrow')
        })
        document.getElementById("down-arrow").addEventListener("click", function(){
          toggleContentAndArrows('book-description', 'up-arrow', 'down-arrow')
        })
        $(".tag").on("click", function() { window.location.href = "/results?" + $(this).attr("value").replace(/,/g, '%2C') })
      }
    </script>
  </body>
</html>